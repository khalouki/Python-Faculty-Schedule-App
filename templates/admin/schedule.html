{% extends "base.html" %}

{% block content %}
<style>
.opacity-50 {
    opacity: 0.5;
}
.pointer-events-none {
    pointer-events: none;
}
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 animate__animated animate__fadeIn">Gestion de l'Emploi du Temps</h2>

    <!-- Card for Adding Schedule -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-8 animate__animated animate__fadeInUp">
        <h4 class="text-xl font-semibold text-gray-700 mb-4">Ajouter un Intervalle</h4>
        <form method="POST" action="{{ url_for('admin.manage_schedule') }}" class="space-y-6">
            <input type="hidden" name="_method" value="POST">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label for="program" class="block text-sm font-medium text-gray-700 mb-2">Filière</label>
                    <select id="program" name="program" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        {% for program in programs %}
                        <option value="{{ program.id }}">{{ program.name }} ({{ program.department.name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700 mb-2">Année</label>
                    <select id="year" name="year" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        <option value="1">1ère année</option>
                        <option value="2">2ème année</option>
                        <option value="3">3ème année</option>
                    </select>
                </div>
                <div>
                    <label for="course" class="block text-sm font-medium text-gray-700 mb-2">Cours</label>
                    <select id="course" name="course" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.name }} ({{ course.type }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="teacher" class="block text-sm font-medium text-gray-700 mb-2">Enseignant</label>
                    <select id="teacher" name="teacher" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.id }}">{{ teacher.first_name }} {{ teacher.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="group" class="block text-sm font-medium text-gray-700 mb-2">Groupe</label>
                    <select id="group" name="group" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                        <option value="all">Tous les groupes</option>
                    </select>
                </div>
                <div>
                    <label for="room" class="block text-sm font-medium text-gray-700 mb-2">Salle</label>
                    <select id="room" name="room" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }} ({{ room.type }}, {{ room.capacity }} places)</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="day" class="block text-sm font-medium text-gray-700 mb-2">Jour</label>
                    <select id="day" name="day" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                        <option value="Lundi">Lundi</option>
                        <option value="Mardi">Mardi</option>
                        <option value="Mercredi">Mercredi</option>
                        <option value="Jeudi">Jeudi</option>
                        <option value="Vendredi">Vendredi</option>
                        <option value="Samedi">Samedi</option>
                    </select>
                </div>
                <div>
                    <label for="start_time" class="block text-sm font-medium text-gray-700 mb-2">Heure de début</label>
                    <input type="time" id="start_time" name="start_time" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                </div>
                <div>
                    <label for="end_time" class="block text-sm font-medium text-gray-700 mb-2">Heure de fin</label>
                    <input type="time" id="end_time" name="end_time" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                </div>
            </div>
            <div class="flex space-x-4 mt-6">
                <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200">Ajouter le créneau</button>
            </div>
        </form>
    </div>

    <!-- Card for Schedule Grid -->
    <div class="bg-white shadow-md rounded-lg p-6 animate__animated animate__fadeInUp">
        <h4 class="text-xl font-semibold text-gray-700 mb-4">Emploi du temps</h4>

        <!-- Filter by Program and Year with Search Form -->
        <form id="filterForm" method="GET" action="{{ url_for('admin.manage_schedule') }}" class="flex space-x-4 mb-6">
            <div>
                <label for="filter_program" class="block text-sm font-medium text-gray-700 mb-2">Filière</label>
                <select id="filter_program" name="program_id" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    <option value="">Sélectionner une filière</option>
                    {% for program in programs %}
                    <option value="{{ program.id }}" {% if selected_program_id and selected_program_id == program.id|string %}selected{% endif %}>{{ program.name }} ({{ program.department.name }})</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="filter_year" class="block text-sm font-medium text-gray-700 mb-2">Année</label>
                <select id="filter_year" name="year" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    <option value="">Sélectionner une année</option>
                    <option value="1" {% if selected_year and selected_year == '1' %}selected{% endif %}>1ère année</option>
                    <option value="2" {% if selected_year and selected_year == '2' %}selected{% endif %}>2ème année</option>
                    <option value="3" {% if selected_year and selected_year == '3' %}selected{% endif %}>3ème année</option>
                </select>
            </div>
            <div class="self-end">
                <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200">Rechercher</button>
                <a id="export_pdf_link" href="#" class="inline-flex items-center px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-200 opacity-50 pointer-events-none">Exporter en PDF</a>
            </div>
        </form>

        <!-- Schedule Grid -->
        {% if schedule_grid and selected_program_id and selected_year %}
        <div class="overflow-x-auto">
            <table id="schedule_grid" class="min-w-full border border-gray-200 divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200">Jour \ Heure</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200">08h30-10h30</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200">10h40-12h40</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200">13h00-15h00</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200">15h10-17h10</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-200">17h20-19h20</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for day in days %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-600 border border-gray-200">{{ day }}</td>
                        {% for slot_idx in range(time_slots|length) %}
                        {% set start_time, end_time = time_slots[slot_idx] %}
                        <td class="px-6 py-4 text-sm text-gray-600 border border-gray-200" data-day="{{ day }}" data-slot="{{ start_time }}-{{ end_time }}">
                            {% for schedule in schedule_grid[day][slot_idx] %}
                            <div class="bg-blue-100 p-2 rounded mb-1 text-center" data-schedule-id="{{ schedule.id }}">
                                <div class="font-semibold">{{ schedule.course.name }} ({{ schedule.course.type }})</div>
                                <div>{{ schedule.teacher.first_name }} {{ schedule.teacher.last_name }}</div>
                                <div>{{ schedule.group.name if schedule.group else 'Tous' }}</div>
                                <div>{{ schedule.room.name }}</div>
                                <div class="mt-2">
                                    <button type="button" class="text-white bg-blue-600 rounded px-2 py-1 text-xs" onclick="openScheduleModal({{ schedule.id }}, {{ schedule.program_id }}, '{{ schedule.year }}', {{ schedule.course_id }}, {{ schedule.teacher_id }}, '{{ schedule.group_id if schedule.group_id else 'all' }}', {{ schedule.room_id }}, '{{ schedule.day }}', '{{ schedule.start_time.strftime('%H:%M') }}', '{{ schedule.end_time.strftime('%H:%M') }}')">Modifier</button>
                                    <form action="{{ url_for('admin.delete_schedule', schedule_id=schedule.id) }}" method="POST" class="inline">
                                        <button type="submit" class="text-white bg-red-500 rounded px-2 py-1 text-xs" onclick="return confirm('Voulez-vous vraiment supprimer ce créneau ?')">Supprimer</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        {% set program_name = programs | selectattr('id', 'equalto', selected_program_id | int) | first | attr('name') if selected_program_id else 'toutes les filières' %}
        {% set year_text = selected_year ~ 'ère année' if selected_year == '1' else selected_year ~ 'ème année' if selected_year else 'toutes les années' %}
        <p class="text-gray-500 text-center py-4">
            Aucun Intervalle trouvé pour {{ program_name }} ({{ year_text }}). Veuillez sélectionner une filière et une année pour afficher l'emploi du temps.
        </p>
        {% endif %}
    </div>

    <!-- Modal for Editing Schedule -->
    <div id="editScheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl mx-auto">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Modifier le Intervalle</h3>
            <form method="POST" action="{{ url_for('admin.manage_schedule') }}" class="space-y-4">
                <input type="hidden" name="_method" value="PUT">
                <input type="hidden" name="schedule_id" id="edit_schedule_id">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="edit_program" class="block text-sm font-medium text-gray-700 mb-2">Filière</label>
                        <select id="edit_program" name="program" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            {% for program in programs %}
                            <option value="{{ program.id }}">{{ program.name }} ({{ program.department.name }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="edit_year" class="block text-sm font-medium text-gray-700 mb-2">Année</label>
                        <select id="edit_year" name="year" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            <option value="1">1ère année</option>
                            <option value="2">2ème année</option>
                            <option value="3">3ème année</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit_course" class="block text-sm font-medium text-gray-700 mb-2">Cours</label>
                        <select id="edit_course" name="course" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }} ({{ course.type }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="edit_teacher" class="block text-sm font-medium text-gray-700 mb-2">Enseignant</label>
                        <select id="edit_teacher" name="teacher" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.first_name }} {{ teacher.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="edit_group" class="block text-sm font-medium text-gray-700 mb-2">Groupe</label>
                        <select id="edit_group" name="group" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                            <option value="all">Tous les groupes</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit_room" class="block text-sm font-medium text-gray-700 mb-2">Salle</label>
                        <select id="edit_room" name="room" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            {% for room in rooms %}
                            <option value="{{ room.id }}">{{ room.name }} ({{ room.type }}, {{ room.capacity }} places)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="edit_day" class="block text-sm font-medium text-gray-700 mb-2">Jour</label>
                        <select id="edit_day" name="day" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                            <option value="Lundi">Lundi</option>
                            <option value="Mardi">Mardi</option>
                            <option value="Mercredi">Mercredi</option>
                            <option value="Jeudi">Jeudi</option>
                            <option value="Vendredi">Vendredi</option>
                            <option value="Samedi">Samedi</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit_start_time" class="block text-sm font-medium text-gray-700 mb-2">Heure de début</label>
                        <input type="time" id="edit_start_time" name="start_time" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    </div>
                    <div>
                        <label for="edit_end_time" class="block text-sm font-medium text-gray-700 mb-2">Heure de fin</label>
                        <input type="time" id="edit_end_time" name="end_time" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="py-2 px-4 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200" onclick="closeScheduleModal()">Annuler</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

</div>
<script src="{{ url_for('static', filename='js/admin_sche.js') }}?v={{ config.VERSION }}"></script>

<!-- Optionally include admin_sche.js if it contains additional non-conflicting code -->
<!-- <script src="{{ url_for('static', filename='js/admin_sche.js') }}?v={{ config.VERSION }}"></script> -->
{% endblock %}